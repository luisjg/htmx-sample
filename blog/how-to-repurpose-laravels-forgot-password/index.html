<center>
<img src="https://res.cloudinary.com/dfhliq7vp/image/upload/f_auto,q_auto:eco/luisjg/avif/1200px-LaravelLogo.avif" width="17%" alt="Laravel logo" title="Laravel logo">
</center>

<h2 id="introduction">Introduction</h2>
<hr />
<p>Ever since Laravel 5.0, I've been consistently impressed with its
in-built features. A standout is its rapid project setup with user
authentication. Here’s a look:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>  <span class="ex">$</span> composer create-project <span class="at">--prefer-dist</span> laravel/laravel <span class="op">&lt;</span>project-name<span class="op">&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">$</span> cd <span class="op">&lt;</span>project-name<span class="op">&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">$</span> php artisan migrate</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">$</span> php artisan make:auth</span></code></pre></div>
<p>With this, you have an authentication system. And while Laravel has
its defaults, what if you need customization?</p>
<h2 id="the-challenge">The Challenge</h2>
<hr />
<p>How can we create a password-less user system with just an email and
name? Let's dig in.</p>
<h2 id="the-solution">The Solution</h2>
<hr />
<p>Rather than reinventing the wheel, we're using Laravel's default
approach as if it's a password reset.</p>
<p><strong>Application Flow:</strong></p>
<ol type="1">
<li>Collect from the user their <code>first_name</code>,
<code>last_name</code>, and <code>email</code>.</li>
<li>Generate a temporary password and an expiration token. Store one key
in the <code>password_resets</code> table.</li>
<li>Email the user with a link to set their password.</li>
</ol>
<p>We'll modify the default users table migration to fit our needs:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode php"><code class="sourceCode php"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>  Schema::create(<span class="st">&#39;users&#39;</span><span class="ot">,</span> <span class="kw">function</span> (Blueprint <span class="va">$table</span>) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">$table</span>-&gt;bigIncrements(<span class="st">&#39;id&#39;</span>)<span class="ot">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">$table</span>-&gt;<span class="dt">string</span>(<span class="st">&#39;first_name&#39;</span>)<span class="ot">;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">$table</span>-&gt;<span class="dt">string</span>(<span class="st">&#39;last_name&#39;</span>)<span class="ot">;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">$table</span>-&gt;<span class="dt">string</span>(<span class="st">&#39;email&#39;</span>)-&gt;unique()<span class="ot">;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">$table</span>-&gt;<span class="dt">string</span>(<span class="st">&#39;password&#39;</span>)<span class="ot">;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">$table</span>-&gt;timestamps()<span class="ot">;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  })<span class="ot">;</span></span></code></pre></div>
<p>Next, set up core functionalities:</p>
<ul>
<li><strong>Generate a Hashed Key and Token:</strong></li>
</ul>
<div class="sourceCode" id="cb3"><pre
class="sourceCode php"><code class="sourceCode php"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">/**</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">    * Create a hashed key for the user.</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">    *  </span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">    * </span><span class="an">@return</span><span class="co"> string</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">protected</span> <span class="kw">function</span> createHashedKey()</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>      <span class="va">$key</span> <span class="op">=</span> config(<span class="st">&#39;app.key&#39;</span>)<span class="ot">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (Str::startsWith(<span class="va">$key</span><span class="ot">,</span> <span class="st">&#39;base64:&#39;</span>)) {</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>          <span class="va">$key</span> <span class="op">=</span> <span class="fu">base64_decode</span>(<span class="fu">substr</span>(<span class="va">$key</span><span class="ot">,</span> <span class="dv">7</span>))<span class="ot">;</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>      <span class="va">$key</span> <span class="op">=</span> <span class="fu">hash_hmac</span>(<span class="st">&#39;sha256&#39;</span><span class="ot">,</span> Str::random(<span class="dv">40</span>)<span class="ot">,</span> <span class="va">$key</span>)<span class="ot">;</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="va">$key</span><span class="ot">;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre
class="sourceCode php"><code class="sourceCode php"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">/**</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">    * Create a new token for the user.</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">    *</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">    * </span><span class="an">@return</span><span class="co"> string</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">protected</span> <span class="kw">function</span> createNewToken(<span class="va">$hashedKey</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">Hash</span>::make(<span class="va">$hashedKey</span>)<span class="ot">;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<ul>
<li><strong>Token Comparison &amp; Deletion:</strong></li>
</ul>
<div class="sourceCode" id="cb5"><pre
class="sourceCode php"><code class="sourceCode php"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">/**</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co">    * </span><span class="an">@param</span><span class="co"> </span><span class="cv">$token</span><span class="co"> the emailed token</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">    * </span><span class="an">@param</span><span class="co"> </span><span class="cv">$hashedKey</span><span class="co"> the saved key on the password_resets</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">    * </span><span class="an">@return</span><span class="co"> boolean</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">private</span> <span class="kw">function</span> compareTokens(<span class="va">$token</span><span class="ot">,</span> <span class="va">$hashedKey</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">Hash</span>::check(<span class="va">$token</span><span class="ot">,</span> <span class="va">$hashedKey</span>)<span class="ot">;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre
class="sourceCode php"><code class="sourceCode php"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">/**</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">    * Delete expired tokens.</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">    *</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">    * </span><span class="an">@return</span><span class="co"> void</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">private</span> <span class="kw">function</span> deleteExpiredTokens()</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>      <span class="va">$expiredAt</span> <span class="op">=</span> Carbon::now()-&gt;subSeconds(config(<span class="st">&#39;app.token_expiration_date&#39;</span>))<span class="ot">;</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>      PasswordReset::where(<span class="st">&#39;created_at&#39;</span><span class="ot">,</span> <span class="st">&#39;&lt;&#39;</span><span class="ot">,</span> <span class="va">$expiredAt</span>)-&gt;delete()<span class="ot">;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">/**</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co">    * Delete a token record by user email.</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co">    *</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co">    * </span><span class="an">@param</span><span class="co"> </span><span class="cv">$email</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co">    * </span><span class="an">@return</span><span class="co"> void</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">private</span> <span class="kw">function</span> delete(<span class="va">$email</span>)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>      PasswordReset::whereEmail(<span class="va">$email</span>)-&gt;delete()<span class="ot">;</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>Implementation becomes straightforward. We create our token and
keys:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode php"><code class="sourceCode php"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//...</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">$hashedKey</span> <span class="op">=</span> <span class="va">$this</span>-&gt;createHashedKey()<span class="ot">;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">$token</span> <span class="op">=</span> <span class="va">$this</span>-&gt;createNewToken(<span class="va">$hashedKey</span>)<span class="ot">;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">//...</span></span></code></pre></div>
<p>Then save the generated token to our <code>password_resets</code>
table as well as the user account with their temporary password:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode php"><code class="sourceCode php"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">//..</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// $input comes from a validated Illuminate\Http\Request object.</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// A database transaction saves us from having incomplete data being stored.</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span> {</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="cn">DB</span>::transaction(<span class="kw">function</span> () <span class="kw">use</span> (<span class="va">$token</span><span class="ot">,</span> <span class="va">$input</span>) {</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>      PasswordReset::create([</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;email&#39;</span> =&gt; <span class="va">$input</span>[<span class="st">&#39;email&#39;</span>]<span class="ot">,</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;token&#39;</span> =&gt; <span class="va">$token</span><span class="ot">,</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;created_at&#39;</span> =&gt; Carbon::now()-&gt;toDateTimeString()</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>      ])<span class="ot">;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>      User::create([</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;first_name&#39;</span> =&gt; <span class="va">$input</span>[<span class="st">&#39;first_name&#39;</span>]<span class="ot">,</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;last_name&#39;</span> =&gt; <span class="va">$input</span>[<span class="st">&#39;last_name&#39;</span>]<span class="ot">,</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;email&#39;</span> =&gt; <span class="va">$input</span>[<span class="st">&#39;email&#39;</span>]<span class="ot">,</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;password&#39;</span> =&gt; Str::random()</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>      ])<span class="ot">;</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    })<span class="ot">;</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">catch</span> (\<span class="bu">PDOException</span> <span class="va">$e</span>) {</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// catch exception</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">//..</span></span></code></pre></div>
<p>Finally we send the user an email containing the hashed token:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode php"><code class="sourceCode php"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">//..</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// email user</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Mail</span>::to(<span class="va">$input</span>[<span class="st">&#39;email&#39;</span>])-&gt;send(<span class="kw">new</span> AccountRegistration(<span class="va">$input</span><span class="ot">,</span> <span class="va">$hashedKey</span>))<span class="ot">;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">//...</span></span></code></pre></div>
<p>Once a user receives their email with the password reset/account
activation link. We will call the <code>deleteExpiredTokens()</code>
look up the user by their email and compare the emailed hashedKey with
the token we saved on the database. Once we do that we delete the token
from the database.</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode php"><code class="sourceCode php"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">//...</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">$this</span>-&gt;deleteExpiredTokens()<span class="ot">;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">$user</span> <span class="op">=</span> PasswordReset::whereEmail(<span class="va">$email</span>)-&gt;first()<span class="ot">;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span><span class="fu">is_null</span>(<span class="va">$user</span>)) {</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>      <span class="va">$result</span> <span class="op">=</span> <span class="va">$this</span>-&gt;compareTokens(<span class="va">$token</span><span class="ot">,</span> <span class="va">$user</span>-&gt;token)<span class="ot">;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="va">$result</span>) {</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">$this</span>-&gt;delete(<span class="va">$email</span>)<span class="ot">;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">// allow the user to reset their password</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// by displaying a front end view with the password reset fields.</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">//...</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 id="in-closing">In closing</h2>
<hr />
<p>Harnessing Laravel’s capabilities, you can now effortlessly provision
users. Ready to tackle the frontend? Happy coding!</p>
